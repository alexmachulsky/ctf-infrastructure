#!/bin/bash
#
# Vulnerability Validation Script
# Verifies that the sudo find privilege escalation is correctly configured
# Exits with non-zero status if any check fails
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
CTF_USER="ctf"
SUDOERS_FILE="/etc/sudoers.d/ctf-find"
FLAG_FILE="/root/flag.txt"

EXIT_CODE=0

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Vulnerability Validation${NC}"
echo -e "${BLUE}  Checking Sudo Find Configuration${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Function to fail a check
fail_check() {
    EXIT_CODE=1
    echo -e "${RED}✗ FAILED${NC}: $1"
}

# Function to pass a check
pass_check() {
    echo -e "${GREEN}✓ PASSED${NC}: $1"
}

# Check 1: Script must be run as root
echo -e "${YELLOW}[CHECK 1]${NC} Verifying script is run with root privileges..."
if [[ $EUID -ne 0 ]]; then
    fail_check "Script must be run as root"
    exit 1
else
    pass_check "Running as root"
fi
echo ""

# Check 2: CTF user exists
echo -e "${YELLOW}[CHECK 2]${NC} Checking if CTF user exists..."
if id "$CTF_USER" &>/dev/null; then
    USER_INFO=$(id "$CTF_USER")
    pass_check "User '$CTF_USER' exists ($USER_INFO)"
else
    fail_check "User '$CTF_USER' does not exist"
fi
echo ""

# Check 3: Sudoers file exists and has correct permissions
echo -e "${YELLOW}[CHECK 3]${NC} Checking sudoers file..."
if [ -f "$SUDOERS_FILE" ]; then
    PERMS=$(stat -c '%a' "$SUDOERS_FILE")
    if [ "$PERMS" = "440" ] || [ "$PERMS" = "640" ]; then
        pass_check "Sudoers file exists with correct permissions ($PERMS)"
    else
        fail_check "Sudoers file has incorrect permissions ($PERMS, should be 440 or 640)"
    fi
    
    # Validate syntax
    if visudo -c -f "$SUDOERS_FILE" &>/dev/null; then
        pass_check "Sudoers file syntax is valid"
    else
        fail_check "Sudoers file has syntax errors"
    fi
else
    fail_check "Sudoers file does not exist at $SUDOERS_FILE"
fi
echo ""

# Check 4: Sudoers file contains correct rule
echo -e "${YELLOW}[CHECK 4]${NC} Checking sudoers rule configuration..."
if [ -f "$SUDOERS_FILE" ]; then
    if grep -q "^$CTF_USER.*NOPASSWD.*find" "$SUDOERS_FILE"; then
        RULE=$(grep "^$CTF_USER" "$SUDOERS_FILE")
        pass_check "Sudoers rule configured correctly"
        echo -e "${BLUE}    Rule:${NC} $RULE"
    else
        fail_check "Sudoers rule not found or incorrect in $SUDOERS_FILE"
    fi
else
    fail_check "Cannot check rule - file does not exist"
fi
echo ""

# Check 5: User can execute sudo find
echo -e "${YELLOW}[CHECK 5]${NC} Verifying sudo permissions for user..."
SUDO_LIST=$(sudo -l -U "$CTF_USER" 2>/dev/null || echo "")
if echo "$SUDO_LIST" | grep -q "/usr/bin/find"; then
    pass_check "User '$CTF_USER' can execute /usr/bin/find via sudo"
    echo -e "${BLUE}    Allowed commands:${NC}"
    echo "$SUDO_LIST" | grep -A 2 "may run" | tail -n +2 | sed 's/^/    /'
else
    fail_check "User '$CTF_USER' cannot execute /usr/bin/find via sudo"
fi
echo ""

# Check 6: Test actual execution (without full exploitation)
echo -e "${YELLOW}[CHECK 6]${NC} Testing sudo find execution..."
if sudo -u "$CTF_USER" sudo -n /usr/bin/find /tmp -maxdepth 0 -quit &>/dev/null; then
    pass_check "sudo find executes without password prompt"
else
    fail_check "sudo find execution failed or requires password"
fi
echo ""

# Check 7: Find binary exists and is executable
echo -e "${YELLOW}[CHECK 7]${NC} Checking find binary..."
if [ -x "/usr/bin/find" ]; then
    FIND_VERSION=$(find --version | head -n 1)
    pass_check "find binary exists and is executable"
    echo -e "${BLUE}    Version:${NC} $FIND_VERSION"
else
    fail_check "find binary not found or not executable"
fi
echo ""

# Check 8: Flag file exists and is protected
echo -e "${YELLOW}[CHECK 8]${NC} Checking flag file..."
if [ -f "$FLAG_FILE" ]; then
    OWNER=$(stat -c '%U:%G' "$FLAG_FILE")
    PERMS=$(stat -c '%a' "$FLAG_FILE")
    if [ "$OWNER" = "root:root" ] && [ "$PERMS" = "600" ]; then
        pass_check "Flag file exists with correct ownership and permissions"
        echo -e "${BLUE}    Location:${NC} $FLAG_FILE"
        echo -e "${BLUE}    Owner:${NC} $OWNER"
        echo -e "${BLUE}    Permissions:${NC} $PERMS"
    else
        fail_check "Flag file has incorrect ownership ($OWNER) or permissions ($PERMS)"
    fi
else
    fail_check "Flag file does not exist at $FLAG_FILE"
fi
echo ""

# Check 9: CTF user cannot read flag directly
echo -e "${YELLOW}[CHECK 9]${NC} Verifying flag is protected from CTF user..."
if sudo -u "$CTF_USER" cat "$FLAG_FILE" &>/dev/null; then
    fail_check "CTF user can read flag without privilege escalation (security issue)"
else
    pass_check "Flag is protected - CTF user cannot read it directly"
fi
echo ""

# Summary
echo -e "${BLUE}========================================${NC}"
if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}  ALL CHECKS PASSED${NC}"
    echo -e "${GREEN}  Vulnerability is correctly configured${NC}"
    echo ""
    echo -e "${BLUE}Exploitation Hint:${NC}"
    echo -e "  Login: ssh $CTF_USER@<target-ip>"
    echo -e "  Exploit: sudo find . -exec /bin/bash \\; -quit"
else
    echo -e "${RED}  SOME CHECKS FAILED${NC}"
    echo -e "${RED}  Vulnerability is NOT correctly configured${NC}"
fi
echo -e "${BLUE}========================================${NC}"
echo ""

exit $EXIT_CODE
